name: Deploy Supabase Changes

on:
  push:
    branches:
      - edge-functions
    paths:
      - 'server/supabase/functions/reload-odai/**'  # Edge Functions
      - 'server/supabase/migrations/**'            # Database Migrations

jobs:
  apply_migrations:
    name: Apply Database Migrations
    runs-on: ubuntu-latest
    # このジョブは、migrations 以下に変更があった場合のみ実行
    if: >
      ${{ github.event.head_commit &&
          (
            contains(join(github.event.head_commit.added, ','), 'server/supabase/migrations/') ||
            contains(join(github.event.head_commit.modified, ','), 'server/supabase/migrations/') ||
            contains(join(github.event.head_commit.removed, ','), 'server/supabase/migrations/')
          )
      }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set token env variable
        run: echo "SUPABASE_ACCESS_TOKEN=${{ secrets.SUPABASE_ACCESS_TOKEN }}" >> $GITHUB_ENV
        
      - name: Authenticate Supabase CLI
        run: |
          echo "${{ secrets.SUPABASE_ACCESS_TOKEN }}" | npx supabase login --token -

      - name: Apply Database Migrations
        run: npx supabase db push

  deploy_edge_function:
    name: Deploy Edge Function
    runs-on: ubuntu-latest
    # このジョブは、reload-odai 以下に変更があった場合のみ実行
    if: >
      ${{ github.event.head_commit &&
          (
            contains(join(github.event.head_commit.added, ','), 'server/supabase/functions/reload-odai/') ||
            contains(join(github.event.head_commit.modified, ','), 'server/supabase/functions/reload-odai/') ||
            contains(join(github.event.head_commit.removed, ','), 'server/supabase/functions/reload-odai/')
          )
      }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Authenticate Supabase CLI
        run: |
          echo "${{ secrets.SUPABASE_ACCESS_TOKEN }}" | npx supabase login --token -

      - name: Set Supabase secrets
        run: |
          npx supabase secrets set PROJECT_ID="${{ secrets.PROJECT_ID }}"
          npx supabase secrets set PROJECT_URL="${{ secrets.PROJECT_URL }}"
          npx supabase secrets set ANON_KEY="${{ secrets.ANON_KEY }}"
          npx supabase secrets set ODAI_API_URL="${{ secrets.ODAI_API_URL }}"
          npx supabase secrets set SERVICE_ROLE_KEY="${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}"

      - name: Deploy Edge Function to Supabase
        run: npx supabase functions deploy reload_odai --directory ./server/supabase/functions/reload-odai
